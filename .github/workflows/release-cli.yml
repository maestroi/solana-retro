name: Release CLI

on:
  push:
    tags:
      - 'cli-v*'  # Triggers on tags like cli-v1.0.0
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for (e.g., cli-v1.0.0)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            cli/package-lock.json
            sdk/package-lock.json
      
      - name: Install SDK dependencies
        working-directory: ./sdk
        run: npm ci || npm install
      
      - name: Build SDK
        working-directory: ./sdk
        run: npm run build
      
      - name: Install CLI dependencies
        working-directory: ./cli
        run: npm ci || npm install
      
      - name: Bundle CLI with esbuild
        working-directory: ./cli
        run: npm run build:bundle
      
      - name: Build standalone binaries
        working-directory: ./cli
        run: |
          npx pkg dist/cartridge-cli.cjs \
            --targets node18-linux-x64,node18-linux-arm64,node18-macos-x64,node18-macos-arm64,node18-win-x64 \
            --out-path dist/binaries
      
      - name: Rename binaries
        working-directory: ./cli/dist/binaries
        run: |
          mv cartridge-cli-linux-x64 cartridge-cli-linux-amd64 || true
          mv cartridge-cli-linux-arm64 cartridge-cli-linux-arm64 || true
          mv cartridge-cli-macos-x64 cartridge-cli-darwin-amd64 || true
          mv cartridge-cli-macos-arm64 cartridge-cli-darwin-arm64 || true
          mv cartridge-cli-win-x64.exe cartridge-cli-windows-amd64.exe || true
          ls -la
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-binaries
          path: cli/dist/binaries/cartridge-cli-*
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-binaries
          path: binaries
      
      - name: Create checksums
        run: |
          cd binaries
          for file in cartridge-cli-*; do
            sha256sum "$file" > "${file}.sha256"
          done
          ls -la
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: CLI ${{ steps.tag.outputs.tag }}
          body: |
            ## Solana Retro CLI
            
            Command-line tool for publishing and managing on-chain game cartridges.
            
            ### Installation
            
            Download the binary for your platform and add it to your PATH:
            
            - **Linux (x64)**: `cartridge-cli-linux-amd64`
            - **Linux (ARM64)**: `cartridge-cli-linux-arm64`
            - **macOS (Intel)**: `cartridge-cli-darwin-amd64`
            - **macOS (Apple Silicon)**: `cartridge-cli-darwin-arm64`
            - **Windows (x64)**: `cartridge-cli-windows-amd64.exe`
            
            ### Usage
            
            ```bash
            # List all cartridges
            cartridge-cli list
            
            # Get cartridge info
            cartridge-cli info <cartridge-id>
            
            # Publish a cartridge
            cartridge-cli publish ./my-game.zip
            ```
          files: |
            binaries/cartridge-cli-*
          draft: false
          prerelease: false

